name: 🔄 Auto-Update README Contributions

on:
  schedule:
    # Run every day at 6:00 AM UTC (11:30 AM IST)
    - cron: '0 6 * * *'
  
  # Allow manual triggering
  workflow_dispatch:
  
  # Run when there's a push to main (to capture immediate updates)
  push:
    branches: [ main ]
    paths:
      - '**.md'
      - '**.py'
      - '**.js'
      - '**.ts'
      - '**.sh'

jobs:
  update-readme:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      
    steps:
    - name: 🔄 Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: 🛠️ Setup Environment
      run: |
        sudo apt-get update
        sudo apt-get install -y jq curl git
        
    - name: 📊 Fetch GitHub Stats
      id: github-stats
      run: |
        echo "Fetching GitHub statistics..."
        USER_DATA=$(curl -s -H "Accept: application/vnd.github.v3+json" \
          "https://api.github.com/users/yunus25jmi1")
        
        TOTAL_REPOS=$(echo "$USER_DATA" | jq -r '.public_repos')
        FOLLOWERS=$(echo "$USER_DATA" | jq -r '.followers')
        FOLLOWING=$(echo "$USER_DATA" | jq -r '.following')
        
        echo "total_repos=$TOTAL_REPOS" >> $GITHUB_OUTPUT
        echo "followers=$FOLLOWERS" >> $GITHUB_OUTPUT
        echo "following=$FOLLOWING" >> $GITHUB_OUTPUT
        
        echo "📊 Stats: $TOTAL_REPOS repos, $FOLLOWERS followers, $FOLLOWING following"
    
    - name: 🚀 Run Contribution Update Script
      run: |
        # Make script executable
        chmod +x scripts/update-contributions.sh
        
        # Run the update script
        ./scripts/update-contributions.sh
        
    - name: 📝 Check for Changes
      id: check-changes
      run: |
        if git diff --quiet README.md; then
          echo "has_changes=false" >> $GITHUB_OUTPUT
          echo "No changes detected in README.md"
        else
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "Changes detected in README.md"
          echo "## Changes Made:" >> $GITHUB_STEP_SUMMARY
          git diff --no-index README.md.backup README.md | head -50 >> $GITHUB_STEP_SUMMARY || true
        fi
    
    - name: 🎯 Commit and Push Changes
      if: steps.check-changes.outputs.has_changes == 'true'
      run: |
        # Configure git
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Add changes
        git add README.md
        
        # Create commit message with stats
        CURRENT_DATE=$(date '+%B %d, %Y at %H:%M UTC')
        TOTAL_REPOS="${{ steps.github-stats.outputs.total_repos }}"
        
        git commit -m "🤖 Auto-update README contributions

📅 Updated: $CURRENT_DATE
📊 Stats: $TOTAL_REPOS total repositories
🔄 Auto-generated by GitHub Actions

- Updated recent contributions table
- Refreshed contribution impact metrics  
- Updated repository and network statistics
- Synchronized with latest GitHub data

[skip ci]"
        
        # Push changes
        git push
        
        echo "✅ Successfully updated and pushed README.md"
        echo "## ✅ Update Successful" >> $GITHUB_STEP_SUMMARY
        echo "README.md has been automatically updated with latest contributions!" >> $GITHUB_STEP_SUMMARY
    
    - name: 📄 Upload Backup
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: readme-backup-${{ github.run_number }}
        path: README.md.backup
        retention-days: 30
    
    - name: 🎉 Success Notification
      if: steps.check-changes.outputs.has_changes == 'true'
      run: |
        echo "🎉 README auto-update completed successfully!"
        echo "📈 Latest contributions and statistics have been synced."
        echo "🔗 Check your updated profile: https://github.com/yunus25jmi1"
        
    - name: ℹ️ No Changes Notification  
      if: steps.check-changes.outputs.has_changes == 'false'
      run: |
        echo "ℹ️ No updates needed - README is already current!"
        echo "📊 All contribution data is up to date."
